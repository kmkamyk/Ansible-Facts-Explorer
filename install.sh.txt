#!/bin/bash
set -euo pipefail

# ==============================================================================
# Ansible Facts Explorer (AFE) Installation Script v2.1 for RHEL-based Systems
# ==============================================================================
# This script automates the deployment of the AFE application, including:
# - A dedicated PostgreSQL database with a randomly generated password.
# - The Node.js API backend as a systemd service with interactive setup.
# - An Nginx reverse proxy with automated firewall configuration.
# - Full uninstall capability for clean removal.
#
# See README.md for detailed usage instructions.
# ==============================================================================

# --- Configuration Variables ---
FRONTEND_DIR="/app/afe"
BACKEND_DIR="/data/afe-api"
PGDATA="/var/lib/pgsql/15/data" # Default for RHEL/PostgreSQL 15 module
PGUSER="afeuser"
PGDB="afedb"
# PGPASSWORD is now generated automatically
ENV_FILE="/etc/afe-api.env"
SERVICE_FILE="/etc/systemd/system/afe-api.service"
NGINX_CONF="/etc/nginx/conf.d/afe.conf"

# --- Helper Functions for Logging ---
log_info() {
  echo -e "\033[0;32m[INFO]\033[0m $1"
}

log_warn() {
  echo -e "\033[0;33m[WARN]\033[0m $1"
}

log_error() {
  echo -e "\033[0;31m[ERROR]\033[0m $1" >&2
}

# --- Pre-flight Checks ---
function run_checks() {
    log_info "Running pre-flight checks..."
    local dependencies=("dnf" "systemctl" "npm" "node" "rsync" "sudo")
    local missing_deps=0
    for cmd in "${dependencies[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            log_error "Dependency missing: '$cmd'. Please install it and try again."
            missing_deps=1
        fi
    done
    if [[ $missing_deps -eq 1 ]]; then
        exit 1
    fi
    log_info "All dependencies are present."
}

# --- Installation Functions ---

function deploy_frontend() {
  log_info "Deploying AFE frontend..."

  if [[ ! -d "dist" ]]; then
     log_error "Frontend build directory 'dist' not found. Please build the frontend first:"
     log_error "  npm install && npm run build"
     exit 1
  fi
  
  log_info "Syncing built files from 'dist/' to $FRONTEND_DIR..."
  # The directory is already created by the 'nginx' or 'all' step
  rsync -a --delete dist/ "$FRONTEND_DIR/"
  chown -R nginx:nginx "$FRONTEND_DIR"

  if systemctl is-active --quiet nginx; then
    log_info "Reloading Nginx to apply changes..."
    nginx -t && systemctl reload nginx
  fi

  log_info "Frontend deployed successfully to $FRONTEND_DIR"
}

function deploy_backend() {
  log_info "Deploying AFE backend..."
  
  local PGPASSWORD=$1

  # Create a non-login system user for the service
  if ! id "afeapi" &>/dev/null; then
    log_info "Creating system user 'afeapi'..."
    useradd -r -s /usr/sbin/nologin afeapi
  fi

  log_info "Syncing backend files to $BACKEND_DIR..."
  if [[ ! -d "fact-api-backend" ]]; then
      log_error "Backend directory 'fact-api-backend' not found. Please ensure it exists in the current directory."
      exit 1
  fi
  mkdir -p "$BACKEND_DIR"
  rsync -a --delete fact-api-backend/ "$BACKEND_DIR/"
  chown -R afeapi:afeapi "$BACKEND_DIR"

  log_info "Installing backend dependencies as user 'afeapi'..."
  sudo -u afeapi npm ci --prefix "$BACKEND_DIR" --prefer-offline --no-audit || sudo -u afeapi npm install --prefix "$BACKEND_DIR"

  log_info "Configuring environment file at $ENV_FILE..."
  
  local AWX_URL=""
  local AWX_TOKEN=""
  
  # Interactive prompts for critical settings
  read -p "Enter your AWX instance URL (e.g., https://awx.example.com): " AWX_URL
  read -sp "Enter your AWX API Token: " AWX_TOKEN
  echo

  tee "$ENV_FILE" >/dev/null <<EOF
# --- Node.js Environment ---
NODE_ENV=production
PORT=4000

# --- Database Configuration ---
DB_HOST=localhost
DB_PORT=5432
DB_USER=$PGUSER
DB_PASSWORD=$PGPASSWORD
DB_NAME=$PGDB

# --- AWX Configuration ---
AWX_URL=${AWX_URL}
AWX_TOKEN=${AWX_TOKEN}
AWX_CONCURRENCY_LIMIT=20
AWX_REQUEST_TIMEOUT=30000
EOF
  chmod 600 "$ENV_FILE"
  chown root:afeapi "$ENV_FILE"

  log_info "Creating systemd service file at $SERVICE_FILE..."
  tee "$SERVICE_FILE" >/dev/null <<EOF
[Unit]
Description=AFE API backend (Node.js)
Documentation=https://github.com/kmkamyk/ansible-facts-explorer
After=network.target postgresql.service

[Service]
Type=simple
User=afeapi
Group=afeapi
WorkingDirectory=$BACKEND_DIR
EnvironmentFile=$ENV_FILE
ExecStart=/usr/bin/node $BACKEND_DIR/server.js
Restart=on-failure
RestartSec=10
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

  log_info "Reloading systemd, enabling and starting afe-api.service..."
  systemctl daemon-reload
  systemctl enable --now afe-api.service
  
  sleep 2
  systemctl status afe-api.service --no-pager

  log_info "Backend deployed to $BACKEND_DIR and running on port 4000."
}

function install_postgres() {
  log_info "Installing and configuring PostgreSQL..."
  
  # Generate a secure password for the database user
  local PGPASSWORD
  PGPASSWORD=$(openssl rand -base64 16)

  log_info "Installing PostgreSQL 15..."
  dnf -y module enable postgresql:15
  dnf install -y postgresql-server postgresql

  if [ ! -d "$PGDATA/base" ]; then
    log_info "Initializing PostgreSQL database at $PGDATA..."
    /usr/bin/postgresql-setup --initdb
  else
    log_warn "PostgreSQL data directory already exists. Skipping initialization."
  fi
  
  log_info "Enabling and starting the postgresql service..."
  systemctl enable --now postgresql

  log_info "Configuring database '$PGDB' and user '$PGUSER'..."
  # Use `sudo -i -u` to ensure commands run in the postgres user's home directory context
  sudo -i -u postgres -- psql -c "SELECT 1 FROM pg_roles WHERE rolname='$PGUSER'" | grep -q 1 || sudo -i -u postgres -- psql -c "CREATE ROLE $PGUSER WITH LOGIN PASSWORD '$PGPASSWORD';"
  sudo -i -u postgres -- psql -lqt | cut -d \| -f 1 | grep -qw "$PGDB" || sudo -i -u postgres -- psql -c "CREATE DATABASE $PGDB OWNER $PGUSER;"
  
  sudo -i -u postgres -- psql -d "$PGDB" -c "GRANT ALL PRIVILEGES ON DATABASE $PGDB TO $PGUSER;"

  log_info "Creating the 'facts' table if it doesn't exist..."
  sudo -i -u postgres -- psql -d "$PGDB" <<SQL
CREATE TABLE IF NOT EXISTS facts (
    id SERIAL PRIMARY KEY,
    hostname VARCHAR(255) UNIQUE NOT NULL,
    data JSONB NOT NULL,
    modified_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
ALTER TABLE facts OWNER TO $PGUSER;
SQL

  log_info "PostgreSQL installed and configured successfully."
  # Return the generated password for use in other functions
  echo "$PGPASSWORD"
}

function configure_nginx() {
  log_info "Installing and configuring Nginx..."

  dnf install -y nginx
  systemctl enable --now nginx

  # Create the webroot directory *before* configuring Nginx to use it.
  # This prevents Nginx from failing to start if the directory doesn't exist.
  log_info "Ensuring frontend directory exists at $FRONTEND_DIR..."
  mkdir -p "$FRONTEND_DIR"
  chown nginx:nginx "$FRONTEND_DIR"

  log_info "Creating Nginx configuration at $NGINX_CONF..."
  tee "$NGINX_CONF" >/dev/null <<EOF
server {
    listen 80;
    server_name _; # Listens on all hostnames

    root $FRONTEND_DIR;
    index index.html;

    # Serve static files for the React app
    location / {
        try_files \$uri /index.html;
    }

    # Proxy API requests to the backend Node.js server
    location /api/ {
        proxy_pass http://127.0.0.1:4000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF
  
  if systemctl is-active --quiet firewalld; then
    log_info "Firewalld is active. Adding rule for HTTP traffic..."
    firewall-cmd --permanent --add-service=http
    firewall-cmd --reload
  fi

  log_info "Testing and reloading Nginx configuration..."
  nginx -t && systemctl reload nginx
  log_info "Nginx configured with frontend at $FRONTEND_DIR and backend proxy."
}

function uninstall_app() {
    log_warn "This will permanently delete the AFE application and its data."
    read -p "Are you sure you want to continue? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Uninstall cancelled."
        exit 0
    fi

    log_info "Stopping and disabling services..."
    systemctl stop afe-api.service nginx || true
    systemctl disable afe-api.service || true

    log_info "Removing files and directories..."
    rm -f "$SERVICE_FILE"
    rm -f "$NGINX_CONF"
    rm -f "$ENV_FILE"
    rm -rf "$FRONTEND_DIR"
    rm -rf "$BACKEND_DIR"

    log_info "Reloading systemd daemon..."
    systemctl daemon-reload
    
    if systemctl is-active --quiet firewalld; then
        log_info "Removing firewall rule for HTTP..."
        firewall-cmd --permanent --remove-service=http
        firewall-cmd --reload
    fi

    read -p "Do you also want to remove the PostgreSQL user and database? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "Dropping database '$PGDB' and user '$PGUSER'..."
        sudo -i -u postgres -- psql -c "DROP DATABASE IF EXISTS $PGDB;"
        sudo -i -u postgres -- psql -c "DROP ROLE IF EXISTS $PGUSER;"
    else
        log_warn "PostgreSQL data was not removed."
    fi

    log_info "Uninstall complete."
}

function show_status() {
    log_info "Checking status of AFE services..."
    echo "--- Nginx Status ---"
    systemctl status nginx --no-pager
    echo
    echo "--- AFE API Backend Status ---"
    systemctl status afe-api.service --no-pager
    echo
    log_info "To check PostgreSQL, run: sudo systemctl status postgresql"
}

### MAIN SCRIPT LOGIC ###
if [[ $EUID -ne 0 ]]; then
   log_error "This script must be run as root (or with sudo)." 
   exit 1
fi

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 [frontend|backend|postgres|nginx|all|uninstall|status]"
  echo "  all:       Runs postgres, nginx, and backend installers."
  echo "  frontend:  Deploys the pre-built React frontend from the 'dist' directory."
  echo "  backend:   Deploys the Node.js backend service (requires DB password)."
  echo "  postgres:  Installs and configures PostgreSQL."
  echo "  nginx:     Installs and configures Nginx."
  echo "  uninstall: Removes all AFE components from the system."
  echo "  status:    Checks the status of AFE services."
  exit 1
fi

run_checks

case "$1" in
  all)
    log_info "Running 'all' tasks: postgres, nginx, backend..."
    GENERATED_PGPASSWORD=$(install_postgres)
    configure_nginx
    deploy_backend "$GENERATED_PGPASSWORD"
    
    echo -e "\n\033[1;32m========================= INSTALLATION SUMMARY ========================="
    log_info "All backend services deployed successfully."
    log_info "Database User:      $PGUSER"
    log_info "Database Name:        $PGDB"
    log_warn "Generated DB Password: $GENERATED_PGPASSWORD (Please save this password securely!)"
    log_info "Frontend Location:    $FRONTEND_DIR"
    log_info "Backend Location:     $BACKEND_DIR"
    log_info "Environment File:     $ENV_FILE"
    log_info "Next Step: Remember to build and deploy the frontend using:"
    log_info "  npm install && npm run build"
    log_info "  sudo $0 frontend"
    echo -e "\033[1;32m======================================================================\033[0m"
    ;;
  frontend)
    deploy_frontend
    ;;
  backend)
    log_error "The 'backend' command cannot be run standalone due to password generation."
    log_error "Please use the 'all' command to install the full backend stack."
    exit 1
    ;;
  postgres)
    install_postgres
    ;;
  nginx)
    configure_nginx
    ;;
  uninstall)
    uninstall_app
    ;;
  status)
    show_status
    ;;
  *)
    log_error "Invalid option: $1"
    echo "Usage: $0 [frontend|backend|postgres|nginx|all|uninstall|status]"
    exit 1
    ;;
esac

log_info "Script finished."
